# M1 XV7001BB陀螺仪项目技术参考手册

> **版本**: v1.0 | **日期**: 2025-11-28 | **平台**: STM32F103 + XV7001BB  
> **用途**: 供AI快速理解项目技术细节，从零开始重建项目

---

## 1. 硬件配置速查

### 1.1 系统参数
```c
MCU: STM32F103
系统时钟: 8MHz (HSI内部时钟 × PLL×2)
SPI2波特率: 1MHz (Mode 3: CPOL=1, CPHA=1)
CAN波特率: 500Kbps
FreeRTOS滴答: 1kHz
```

### 1.2 引脚映射表
| 引脚 | 功能 | 模式 | 速度 | 说明 |
|------|------|------|------|------|
| PB9 | LED | 推挽输出 | 低速 | 系统状态指示 |
| PB12 | SPI_NSS | 推挽输出 | 低速 | 片选（低有效） |
| PB13 | SPI_SCK | 复用推挽 | 高速 | SPI时钟 |
| PB14 | SPI_MISO | 浮空输入 | - | SPI输入 |
| PB15 | SPI_MOSI | 复用推挽 | 高速 | SPI输出 |
| PA11 | CAN_RX | 浮空输入 | - | CAN接收 |
| PA12 | CAN_TX | 复用推挽 | 高速 | CAN发送 |

---

## 2. XV7001BB寄存器定义

### 2.1 寄存器地址
```c
#define XV7_REG_STATUS      0x01  // 状态寄存器 (R, 8-bit)
#define XV7_REG_RATE_READ   0x02  // 角速度数据 (R, 24-bit)
#define XV7_REG_TEMP_READ   0x03  // 温度数据 (R, 16-bit, 使用12-bit)
#define XV7_REG_IF_CTRL     0x10  // 接口控制 (W, 8-bit)
#define XV7_REG_TS_FORMAT   0x12  // 温度格式 (W, 8-bit)
#define XV7_REG_RATE_CTRL   0x16  // 角速度控制 (W, 8-bit)
#define XV7_REG_DSP_CTL2    0x1E  // DSP控制2 (W, 8-bit)
#define XV7_REG_DSP_CTL3    0x1F  // DSP控制3 (R/W, 8-bit)
#define XV7_REG_FILTER_RST  0x21  // 滤波器复位 (W, 8-bit)
#define XV7_REG_ZERO_CAL    0x23  // 零点校准 (W, 8-bit)
#define XV7_REG_SOFT_RST    0x30  // 软件复位 (W, 8-bit)
#define XV7_REG_SLEEP_OUT   0x31  // 睡眠唤醒 (W, 8-bit)
```

### 2.2 寄存器配置值
```c
// 接口控制
#define XV7_IF_CTL_4WIRE_SPI    0x00  // 4线SPI模式

// 温度格式
#define XV7_TEMP_FMT_12BIT      0x01  // 12-bit温度输出

// 角速度控制
#define XV7_RATE_CTRL_24BIT     0x01  // 24-bit角速度输出

// DSP控制3
#define XV7_EN_CALIB_CMD        0x01  // bit0: 使能校准命令

// 状态寄存器位
#define XV7_STATUS_PROC_OK      0x08  // bit3: 处理器就绪
#define XV7_STATUS_STATE_MASK   0x07  // bit0~2: 状态码
```

---

## 3. 数据结构定义

```c
// 状态码枚举
typedef enum {
    XV7_OK = 0x00,          // 成功
    XV7_ERR_STATE = 0x01,   // 参数错误
    XV7_ERR_SPI = 0x02,     // SPI通信错误
    XV7_ERR_TIMEOUT = 0x03  // 超时
} XV7_Status;

// 状态寄存器
typedef struct {
    uint8_t status_raw;   // 原始字节
    bool proc_ready;      // 处理器就绪 (bit3)
    uint8_t state_code;   // 状态码 (bit2:0)
} XV7_StatusReg;

// 角速度数据
typedef struct {
    int16_t raw;   // 原始16-bit值
    float dps;     // 角速度(°/s), 量程±100°/s
} XV7_GyroData;

// 温度数据
typedef struct {
    int16_t raw;      // 原始12-bit值
    float celsius;    // 摄氏温度 (-40~85°C)
} XV7_TempData;
```

---

## 4. 核心算法

### 4.1 温度转换
```c
// 公式: T(°C) = (RAW - 1331) / 10.0
static float prv_temp_raw_to_celsius(uint16_t raw) {
    return ((float)raw - 1331.0f) / 10.0f;
}

// 温度读取处理
uint16_t raw = (uint16_t)(buf[0] << 2) | ((buf[1] >> 6) & 0x03U);
temp->celsius = prv_temp_raw_to_celsius(raw) + s_temp_bias_c;
```

### 4.2 角速度转换（24-bit符号扩展）
```c
#define XV7_GYRO_SCALE_24BIT 71680.0f

// 读取3字节并拼接
int32_t raw24 = (int32_t)((buf[0] << 16) | (buf[1] << 8) | buf[2]);

// 符号扩展（处理负数）
if (raw24 & 0x800000) {
    raw24 |= 0xFF000000;
}

// 转换为°/s
gyro->dps = (float)raw24 / XV7_GYRO_SCALE_24BIT;
```

### 4.3 零漂校准算法
```c
// 参数
#define BIAS_SAMPLE_COUNT 500  // 采样500个
#define SAMPLE_INTERVAL_MS 10  // 间隔10ms

// 实现（在Task_Main中）
static double bias_accumulator = 0.0;
static uint16_t bias_sample_counter = 0;
static float gyro_bias_dps = 0.0f;
static bool gyro_bias_ready = false;

// 每10ms调用一次
if (!gyro_bias_ready && bias_sample_counter < 500) {
    bias_accumulator += (double)gyro.dps;
    bias_sample_counter++;
    
    if (bias_sample_counter == 500) {
        gyro_bias_dps = (float)(bias_accumulator / 500.0);
        gyro_bias_ready = true;
    }
}
```

### 4.4 角度积分算法
```c
// 参数
#define SAMPLE_PERIOD_S 0.01f  // 采样周期10ms

// 实现（在Task_Main中）
static double gyro_angle_accumulator = 0.0;  // 使用double保持精度
static float gyro_angle_deg = 0.0f;

// 每10ms调用一次
if (gyro_bias_ready) {
    float corrected_dps = gyro.dps - gyro_bias_dps;
    gyro_angle_accumulator += (double)corrected_dps * 0.01;
    gyro_angle_deg = (float)gyro_angle_accumulator;
}
```

---

## 5. 初始化序列（10步骤）

```c
XV7_Status XV7_Init(void) {
    XV7_Status ret;
    uint8_t dummy[3];
    
    prv_delay_ms(2);  // 1. 等待SPI稳定
    
    ret = prv_write_reg(XV7_REG_SOFT_RST, 0x00);  // 2. 软件复位
    if (ret != XV7_OK) return ret;
    prv_delay_ms(2);
    
    ret = prv_write_reg(XV7_REG_SLEEP_OUT, 0x00);  // 3. 唤醒传感器
    if (ret != XV7_OK) return ret;
    prv_delay_ms(2);
    
    ret = prv_write_reg(XV7_REG_IF_CTRL, XV7_IF_CTL_4WIRE_SPI);  // 4. 4线SPI
    if (ret != XV7_OK) return ret;
    
    ret = prv_write_reg(XV7_REG_TS_FORMAT, XV7_TEMP_FMT_12BIT);  // 5. 12-bit温度
    if (ret != XV7_OK) return ret;
    
    ret = prv_write_reg(XV7_REG_DSP_CTL2, 0x07);  // 6. DSP控制2
    if (ret != XV7_OK) return ret;
    
    ret = prv_write_reg(XV7_REG_DSP_CTL3, 0x00);  // 7. DSP控制3
    if (ret != XV7_OK) return ret;
    
    ret = prv_write_reg(XV7_REG_RATE_CTRL, XV7_RATE_CTRL_24BIT);  // 8. 24-bit角速度
    if (ret != XV7_OK) return ret;
    
    prv_delay_ms(80);   // 9. 等待稳定（280ms）
    prv_delay_ms(200);
    
    ret = prv_write_reg(XV7_REG_FILTER_RST, 0x00);  // 10. 复位滤波器
    if (ret != XV7_OK) return ret;
    prv_delay_ms(10);
    
    ret = prv_read_bytes(XV7_REG_RATE_READ, dummy, 3);  // 11. 清空FIFO
    if (ret != XV7_OK) return ret;
    
    return XV7_OK;
}
```

---

## 6. CAN通信协议

### 6.1 发送协议（50Hz）
| ID | 数据类型 | 长度 | 内容 | 频率 |
|----|---------|------|------|------|
| 0x321 | float | 4字节 | 角度(°) | 50Hz |
| 0x322 | float | 4字节 | 温度(°C) | 50Hz |
| 0x323 | float | 4字节 | 角速度(°/s) | 50Hz |

**发送代码示例**:
```c
uint8_t buf[4];
memcpy(buf, &gyro_angle_deg, 4);
CAN_TransmitWithId(0x321, buf, 4);
```

### 6.2 接收协议（事件驱动）
| ID | Data[0] | 功能 |
|----|---------|------|
| 0x100 | 0x01 | 重置零漂校准 |
| 0x100 | 0x02 | 设置增益0.5 |
| 0x100 | 0x03 | 设置增益1.0 |
| 0x100 | 0x04 | 设置增益1.5 |
| 0x100 | 0x05 | 设置增益2.0 |

---

## 7. FreeRTOS任务配置

| 任务名 | 优先级 | 堆栈 | 周期 | 功能 |
|--------|--------|------|------|------|
| Task_Main | 2 | 256字节 | 10ms | 传感器采集+零漂校准+角度积分 |
| Task_Can_Tx | 1 | 256字节 | 20ms | CAN数据发送 |
| Task_Can_Rx | 1 | 256字节 | 事件 | CAN命令接收 |

**Task_Main核心循环**:
```c
void Task_Main(void *argument) {
    const TickType_t xFrequency = pdMS_TO_TICKS(10);
    TickType_t xLastWakeTime = xTaskGetTickCount();
    
    for(;;) {
        // 1. 读取角速度
        XV7_ReadGyro(&gyro);
        
        // 2. 零漂校准（前5秒）
        if (!gyro_bias_ready && bias_sample_counter < 500) {
            bias_accumulator += (double)gyro.dps;
            bias_sample_counter++;
            if (bias_sample_counter == 500) {
                gyro_bias_dps = (float)(bias_accumulator / 500.0);
                gyro_bias_ready = true;
            }
        }
        
        // 3. 角度积分
        if (gyro_bias_ready) {
            float corrected_dps = gyro.dps - gyro_bias_dps;
            gyro_angle_accumulator += (double)corrected_dps * 0.01;
            gyro_angle_deg = (float)gyro_angle_accumulator;
        }
        
        // 4. LED控制
        if (++led_counter >= 50) {
            HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_9);
            led_counter = 0;
        }
        
        vTaskDelayUntil(&xLastWakeTime, xFrequency);
    }
}
```

---

## 8. 关键常量汇总

```c
// SPI配置
#define SPI_MODE_3_CPOL         SPI_POLARITY_HIGH
#define SPI_MODE_3_CPHA         SPI_PHASE_2EDGE
#define SPI_BAUDRATE_PRESCALER  SPI_BAUDRATEPRESCALER_8  // 1MHz

// 传感器参数
#define XV7_GYRO_SCALE_24BIT    71680.0f   // 角速度分辨率
#define XV7_GYRO_RANGE_DPS      100.0f     // 量程±100°/s
#define XV7_TEMP_OFFSET         1331       // 温度偏移
#define XV7_TEMP_SCALE          10.0f      // 温度缩放
#define XV7_SPI_TIMEOUT         100        // SPI超时100ms

// 校准参数
#define BIAS_SAMPLE_COUNT       500        // 零偏采样数
#define BIAS_SAMPLE_TIME_MS     5000       // 校准时间5秒

// 采样参数
#define SAMPLE_PERIOD_MS        10         // 采样周期10ms
#define SAMPLE_FREQUENCY_HZ     100        // 采样频率100Hz

// CAN参数
#define CAN_BAUDRATE_KBPS       500        // CAN波特率500Kbps
#define CAN_ID_ANGLE            0x321      // 角度数据ID
#define CAN_ID_TEMP             0x322      // 温度数据ID
#define CAN_ID_GYRO             0x323      // 角速度数据ID
#define CAN_ID_CMD              0x100      // 命令接收ID

// FreeRTOS优先级
#define TASK_MAIN_PRIORITY      osPriorityNormal        // 2
#define TASK_CAN_PRIORITY       osPriorityBelowNormal   // 1
```

---

## 9. API函数速查

### 9.1 初始化函数
```c
XV7_Status XV7_Init(void);  // 传感器初始化（10步序列）
HAL_StatusTypeDef CAN_Driver_Init(void);  // CAN总线初始化
```

### 9.2 数据读取函数
```c
XV7_Status XV7_ReadStatus(XV7_StatusReg *status);  // 读取状态
XV7_Status XV7_ReadGyro(XV7_GyroData *gyro);      // 读取角速度
XV7_Status XV7_ReadTemp(XV7_TempData *temp);      // 读取温度
```

### 9.3 校准函数
```c
XV7_Status XV7_ZeroCalibrate(void);               // 硬件零点校准
XV7_Status XV7_SetTempAmbient(float target);      // 温度校准
void XV7_SetTempBias(float bias);                 // 设置温度偏置
float XV7_GetTempBias(void);                      // 获取温度偏置
```

### 9.4 CAN通信函数
```c
HAL_StatusTypeDef CAN_Driver_SendByte(uint8_t data);
HAL_StatusTypeDef CAN_Transmit(uint8_t *buf, uint8_t len);
HAL_StatusTypeDef CAN_TransmitWithId(uint32_t id, uint8_t *buf, uint8_t len);
```

---

## 10. 实现步骤检查清单

### 步骤1: 基础框架
- [ ] 创建头文件(main.h, xv7001bb.h, can.h, task_main.h)
- [ ] 定义数据结构(XV7_GyroData, XV7_TempData, XV7_StatusReg)
- [ ] 定义寄存器地址和位定义
- [ ] 定义所有常量

### 步骤2: 系统初始化  
- [ ] HAL库初始化
- [ ] 8MHz系统时钟配置
- [ ] GPIO初始化(LED + SPI NSS)

### 步骤3: SPI2配置
- [ ] SPI2初始化(Mode 3, 1MHz)
- [ ] SPI引脚配置(PB13/14/15)
- [ ] 片选控制宏(XV7_CS_LOW/HIGH)

### 步骤4: XV7001BB基础驱动
- [ ] 实现prv_write_reg()
- [ ] 实现prv_read_bytes()
- [ ] 实现温度转换函数
- [ ] 实现延时函数

### 步骤5: XV7001BB初始化
- [ ] 实现XV7_Init()（10步序列）
- [ ] LED状态指示（初始化失败=快闪）

### 步骤6: 温度读取
- [ ] 实现XV7_ReadTemp()
- [ ] 实现XV7_SetTempAmbient()
- [ ] 实现温度偏置函数
- [ ] 测试温度读取（1Hz采样）

### 步骤7: 角速度读取
- [ ] 实现XV7_ReadGyro()（24-bit处理）
- [ ] 实现XV7_ReadStatus()
- [ ] 实现XV7_ZeroCalibrate()
- [ ] 测试角速度读取（10Hz采样）

### 步骤8: 完整集成
- [ ] 实现CAN驱动(can.c)
- [ ] 实现Task_Main（零漂校准+角度积分）
- [ ] 实现Task_Can_Tx（50Hz发送）
- [ ] 实现Task_Can_Rx（命令接收）
- [ ] FreeRTOS任务创建和启动

---

## 11. 常见问题FAQ

**Q: SPI通信失败？**
- 检查Mode 3配置(CPOL=1, CPHA=1)
- 确认NSS片选低电平有效
- 验证时钟频率1MHz

**Q: 角速度总是0？**
- 确认24-bit拼接正确
- 检查符号扩展处理
- 验证分辨率常量71680

**Q: 零漂校准不准？**
- 确保设备静止
- 检查采样数500个
- 使用double累加

**Q: 角度漂移严重？**
- 确保零漂校准完成
- 使用double累加器
- 确认采样周期10ms

**Q: CAN发送失败？**
- 检查120Ω终端电阻
- 确认波特率500Kbps
- 验证ID范围(0x000~0x7FF)

---

## 12. 调试变量推荐

```c
// 在task_main.c中定义，供调试器查看
volatile float debug_raw_dps = 0.0f;          // 原始角速度
volatile float debug_corrected_dps = 0.0f;    // 补偿后角速度
volatile float debug_temp_celsius = 0.0f;     // 温度
volatile float gyro_bias_dps = 0.0f;          // 零偏值
volatile float gyro_angle_deg = 0.0f;         // 累计角度
volatile bool gyro_bias_ready = false;        // 校准完成标志
volatile uint16_t bias_sample_counter = 0;    // 校准计数器
```

---

**END OF MANUAL**

*本手册包含从零实现M1项目所需的全部关键技术信息*
