# Mission 项目参数手册

## 版本信息
- **项目名称**：Mission（XV7001BB陀螺仪数据采集与CAN通信）
- **MCU型号**：STM32F103C8T6
- **编译环境**：VisualGDB + ARM GCC
- **RTOS**：FreeRTOS
- **文档版本**：v1.0
- **更新日期**：2025年11月

---

# 第一章：硬件配置

## 1.1 MCU基本参数

| 参数 | 值 |
|------|-----|
| 芯片型号 | STM32F103C8T6 |
| 内核 | ARM Cortex-M3 |
| 主频 | 72 MHz |
| Flash | 64 KB |
| SRAM | 20 KB |
| 工作电压 | 3.3V |

## 1.2 引脚分配表

### 1.2.1 SPI2接口（XV7001BB陀螺仪）

| 引脚 | GPIO | 功能 | 方向 | 配置模式 |
|------|------|------|------|----------|
| SCK | PB13 | SPI时钟 | 输出 | AF_PP（复用推挽） |
| MISO | PB14 | 主入从出 | 输入 | Input（浮空输入） |
| MOSI | PB15 | 主出从入 | 输出 | AF_PP（复用推挽） |
| NSS | PB12 | 片选信号 | 输出 | GPIO_Output（软件控制）|

**SPI配置参数**：
```
模式：Mode 3（CPOL=1, CPHA=1）
数据位：8-bit
传输顺序：MSB First（高位在前）
波特率分频：Prescaler = 256（约281.25 kHz）
超时时间：100ms
```

### 1.2.2 CAN1接口

| 引脚 | GPIO | 功能 | 方向 | 配置模式 |
|------|------|------|------|----------|
| CAN_RX | PA11 | CAN接收 | 输入 | Input Pull-up（上拉输入） |
| CAN_TX | PA12 | CAN发送 | 输出 | AF_PP（复用推挽） |

**CAN配置参数**：
```
波特率：500 kbps
工作模式：正常模式（Normal Mode）
采样点：75%
位时序：
  - Prescaler = 2
  - SyncJumpWidth = 1 TQ
  - TimeSeg1 = 5 TQ
  - TimeSeg2 = 2 TQ
  - 总共 = 1 + 5 + 2 = 8 TQ
  - 波特率 = 36MHz / (2 × 8) = 2.25 MHz / 4.5 ≈ 500 kbps
```

### 1.2.3 LED指示灯

| 引脚 | GPIO | 功能 | 配置模式 |
|------|------|------|----------|
| LED | PB9 | 状态指示 | GPIO_Output（推挽输出） |

**LED闪烁模式**：
| 模式 | 频率 | 含义 |
|------|------|------|
| 慢闪 | 1 Hz（500ms周期） | 传感器正常工作 |
| 快闪 | 10 Hz（50ms周期） | 传感器异常/未就绪 |

---

# 第二章：XV7001BB陀螺仪

## 2.1 传感器基本参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 型号 | Epson XV7001BB | 单轴数字陀螺仪 |
| 量程 | ±100°/s | 角速度测量范围 |
| 分辨率（16-bit） | 280 LSB/(°/s) | 约0.00357°/s |
| 分辨率（24-bit） | 71680 LSB/(°/s) | 约0.0000139°/s |
| 温度范围 | -40°C ~ +85°C | 工作温度 |
| 接口 | SPI / I2C | 本项目使用SPI |
| 供电电压 | 3.0V ~ 3.6V | 典型3.3V |

## 2.2 寄存器地址表

| 寄存器名 | 地址 | 读/写 | 功能描述 |
|----------|------|-------|----------|
| DSP_CTL1 | 0x01 | R/W | DSP控制寄存器1 |
| DSP_CTL2 | 0x02 | R/W | DSP控制寄存器2 |
| DSP_CTL3 | 0x03 | R/W | DSP控制寄存器3（校准使能） |
| STATUS | 0x04 | R | 状态寄存器 |
| SLEEP_IN | 0x05 | W | 进入睡眠模式 |
| SLEEP_OUT | 0x06 | W | 退出睡眠模式 |
| STANDBY | 0x07 | W | 进入待机模式 |
| TEMP_READ | 0x08 | R | 温度数据读取 |
| SOFT_RST | 0x09 | W | 软件复位 |
| RATE_READ | 0x0A | R | 角速度数据读取 |
| RATE_CTRL | 0x0B | R/W | 角速度输出控制 |
| ZERO_CAL | 0x0C | W | 零点校准触发 |
| FILTER_RST | 0x0D | W | 滤波器复位 |
| TS_FORMAT | 0x1C | R/W | 温度输出格式 |
| IF_CTRL | 0x1F | R/W | 接口控制 |

## 2.3 状态寄存器（STATUS, 0x04）位定义

| 位 | 名称 | 描述 |
|----|------|------|
| [7:4] | Reserved | 保留 |
| [3] | PROC_OK | 处理器就绪标志（1=就绪） |
| [2:0] | STATE | 设备状态码 |

**状态码定义**：
| 值 | 状态 | 描述 |
|----|------|------|
| 0x00 | SLEEP | 睡眠模式 |
| 0x01 | SLEEP_OUT | 唤醒模式（正常工作） |
| 0x02 | STANDBY | 待机模式 |
| 0x04 | AFTER_POR | 上电复位后 |

## 2.4 SPI通信协议

### 2.4.1 命令帧格式

**写操作**：
```
字节1: [0][地址6:0]     // bit7=0表示写
字节2: [数据7:0]        // 要写入的数据
```

**读操作**：
```
发送: [1][地址6:0]      // bit7=1表示读
接收: [数据7:0]         // 读取的数据
```

### 2.4.2 片选时序

```
NSS(PB12): ‾‾‾‾|_________|‾‾‾‾
                ↑         ↑
             拉低      拉高
           (开始)    (结束)
```

**时序要求**：
- NSS拉低后等待时间：>100ns
- NSS拉高前等待时间：>100ns
- 字节间间隔：无特殊要求

## 2.5 数据转换公式

### 2.5.1 角速度转换

**24-bit模式**（本项目使用）：
```c
// 原始数据拼接（3字节，大端序）
int32_t raw24 = (buf[0] << 16) | (buf[1] << 8) | buf[2];

// 符号扩展（24-bit转32-bit）
if (raw24 & 0x800000) {
    raw24 |= 0xFF000000;
}

// 转换为°/s
float dps = (float)raw24 / 71680.0f;
```

**16-bit模式**：
```c
int16_t raw16 = (buf[0] << 8) | buf[1];
float dps = (float)raw16 / 280.0f;
```

### 2.5.2 温度转换

**12-bit模式**（本项目使用）：
```c
// 提取12-bit值
uint16_t raw = (buf[0] << 2) | ((buf[1] >> 6) & 0x03);

// 转换公式：T = (raw / 16) - offset + bias
float celsius = ((float)raw / 16.0f) - 6.0f + temp_bias;
```

---

# 第三章：CAN通信协议

## 3.1 CAN ID分配

| ID (Hex) | 方向 | 数据类型 | 长度 | 周期 |
|----------|------|----------|------|------|
| 0x321 | TX | 角度数据（float） | 4字节 | 变化时/200ms |
| 0x322 | TX | 温度数据（float） | 4字节 | 1000ms |
| 0x323 | TX | 角速度数据（float） | 4字节 | 变化时/100ms |
| 任意 | RX | 控制命令 | 1~8字节 | 按需 |

## 3.2 发送数据格式

### 3.2.1 角度数据（ID=0x321）

```
字节[0-3]: float类型角度值（小端序，单位：度）
```

**发送条件**：
- 角度变化 ≥ 0.01° 立即发送
- 或距离上次发送 ≥ 200ms 强制发送

### 3.2.2 温度数据（ID=0x322）

```
字节[0-3]: float类型温度值（小端序，单位：°C）
```

**发送周期**：固定1000ms

### 3.2.3 角速度数据（ID=0x323）

```
字节[0-3]: float类型角速度值（小端序，单位：°/s）
```

**发送条件**：
- 角速度变化 ≥ 0.5°/s 立即发送
- 或距离上次发送 ≥ 100ms 强制发送

## 3.3 接收命令格式

| 命令码 | 功能 | 数据格式 |
|--------|------|----------|
| 0x01 | 角度清零 | [0x01] |
| 0x7B | 角度清零（兼容） | [0x7B] |
| 0x02 | 硬件零点校准 | [0x02] |
| 0x03 | 设置软件零偏 | [0x03][float值4字节] |
| 0x04 | 设置增益系数 | [0x04][float值4字节] |

### 3.3.1 命令示例

**角度清零**：
```
CAN ID: 任意
数据: 0x01
长度: 1字节
```

**设置零偏为0.1°/s**：
```
CAN ID: 任意
数据: 0x03 CD CC CC 3D  // 0x03 + float(0.1)小端序
长度: 5字节
```

**设置增益为4.0**：
```
CAN ID: 任意
数据: 0x04 00 00 80 40  // 0x04 + float(4.0)小端序
长度: 5字节
```

---

# 第四章：软件配置参数

## 4.1 FreeRTOS任务配置

| 任务名称 | 函数 | 周期 | 优先级 | 堆栈 |
|----------|------|------|--------|------|
| Task_Main | Task_Main() | 5ms | Normal | 512字 |
| Task_Can_Tx | Task_Can_Tx() | 10ms | Normal | 256字 |
| Task_Can_Rx | Task_Can_Rx() | 5ms | Normal | 256字 |

## 4.2 零偏校准参数

| 参数名 | 值 | 说明 |
|--------|-----|------|
| GYRO_BIAS_SAMPLE_COUNT | 400 | 初始校准采样数（2秒） |
| GYRO_STILL_THRESHOLD_DPS | 0.3 | 静止判断阈值（°/s） |
| GYRO_VERY_STILL_THRESHOLD | 0.1 | 非常静止阈值（°/s） |
| GYRO_BIAS_EMA_ALPHA_SLOW | 0.05 | EMA慢速系数（5%） |
| GYRO_BIAS_EMA_ALPHA_FAST | 0.2 | EMA快速系数（20%） |
| GYRO_BIAS_UPDATE_THRESHOLD | 300 | 更新延迟周期数（1.5秒） |

## 4.3 增益校准参数

| 参数名 | 值 | 说明 |
|--------|-----|------|
| TASK_MAIN_GYRO_GAIN | 4.042 | 默认增益系数 |

**增益计算方法**：
```
增益 = 实际旋转角度 / 积分计算角度
```

---

# 第五章：API接口参考

## 5.1 XV7001BB驱动接口

### XV7_Init()
```c
XV7_Status XV7_Init(void);
```
- **功能**：初始化XV7001BB传感器
- **参数**：无
- **返回值**：XV7_OK=成功，XV7_ERR_SPI=SPI错误
- **调用时机**：系统启动时调用一次

---

### XV7_ReadStatus()
```c
XV7_Status XV7_ReadStatus(XV7_StatusReg *status);
```
- **功能**：读取传感器状态
- **参数**：status - 状态结构体指针
- **返回值**：XV7_OK=成功
- **调用周期**：每个采样周期

---

### XV7_ReadGyro()
```c
XV7_Status XV7_ReadGyro(XV7_GyroData *gyro);
```
- **功能**：读取角速度数据
- **参数**：gyro - 角速度数据结构体指针
- **返回值**：XV7_OK=成功
- **输出**：
  - gyro->raw: 原始16-bit值
  - gyro->dps: 角速度（°/s）

---

### XV7_ReadTemp()
```c
XV7_Status XV7_ReadTemp(XV7_TempData *temp);
```
- **功能**：读取温度数据
- **参数**：temp - 温度数据结构体指针
- **返回值**：XV7_OK=成功
- **输出**：
  - temp->raw: 原始12-bit值
  - temp->celsius: 温度（°C）

---

### XV7_ZeroCalibrate()
```c
XV7_Status XV7_ZeroCalibrate(void);
```
- **功能**：执行硬件零点校准
- **参数**：无
- **返回值**：XV7_OK=成功
- **注意**：调用时设备必须静止！

---

### XV7_SetTempBias() / XV7_GetTempBias()
```c
void XV7_SetTempBias(float bias_celsius);
float XV7_GetTempBias(void);
```
- **功能**：设置/获取温度校准偏置
- **参数**：bias_celsius - 偏置值（°C）

---

### XV7_SetTempAmbient()
```c
XV7_Status XV7_SetTempAmbient(float target_celsius);
```
- **功能**：基于已知环境温度自动校准
- **参数**：target_celsius - 当前真实环境温度
- **原理**：偏置 = 目标温度 - 测量温度

---

## 5.2 CAN驱动接口

### MX_CAN_Init()
```c
void MX_CAN_Init(void);
```
- **功能**：初始化CAN外设寄存器
- **调用时机**：系统启动时

---

### CAN_Driver_Init()
```c
HAL_StatusTypeDef CAN_Driver_Init(void);
```
- **功能**：配置CAN滤波器并启动CAN
- **返回值**：HAL_OK=成功

---

### CAN_Transmit()
```c
HAL_StatusTypeDef CAN_Transmit(uint8_t *pData, uint16_t Size);
```
- **功能**：使用默认ID（0x321）发送数据
- **参数**：
  - pData: 数据指针
  - Size: 数据长度（最大8字节）

---

### CAN_TransmitWithId()
```c
HAL_StatusTypeDef CAN_TransmitWithId(uint32_t StdId, uint8_t *pData, uint16_t Size);
```
- **功能**：使用指定ID发送数据
- **参数**：
  - StdId: CAN标准ID（0x000~0x7FF）
  - pData: 数据指针
  - Size: 数据长度（最大8字节）

---

## 5.3 任务管理接口

### TaskMain_RequestGyroBiasReset()
```c
void TaskMain_RequestGyroBiasReset(void);
```
- **功能**：请求重置零偏校准状态
- **线程安全**：是（使用临界区）

---

### TaskMain_SetGyroGain()
```c
void TaskMain_SetGyroGain(float gain);
```
- **功能**：设置陀螺仪增益系数
- **参数**：gain - 新的增益值
- **线程安全**：是（使用临界区）

---

# 第六章：调试变量参考

## 6.1 实时数据变量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| gyro_angle_deg | double | 积分角度（°） |
| debug_corrected_dps | float | 校正后角速度（°/s） |
| debug_raw_dps | float | 原始角速度（°/s） |
| debug_temp_celsius | float | 当前温度（°C） |

## 6.2 校准状态变量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| gyro_bias_ready | bool | 零偏校准完成标志 |
| gyro_bias_dps | float | 当前零偏值（°/s） |
| sensor_ready_once | bool | 传感器已就绪标志 |

## 6.3 统计变量

| 变量名 | 类型 | 说明 |
|--------|------|------|
| sample_count | uint32_t | 总采样计数 |
| not_ready_counter | uint32_t | 传感器未就绪计数 |
| can_rx_count | uint32_t | CAN接收消息计数 |
| gyro_max | float | 历史最大角速度 |
| gyro_min | float | 历史最小角速度 |

---

# 第七章：算法说明

## 7.1 零偏校准算法

### 7.1.1 初始校准（启动阶段）

```
1. 检测静止：|当前值 - 上次值| < 0.3°/s
2. 如果静止：累加采样值
3. 采集400个样本后计算平均值作为零偏
4. 如果检测到运动：重新开始采样
```

### 7.1.2 动态校准（运行阶段）

```
1. 检测静止持续时间 > 1.5秒
2. 使用EMA更新零偏：
   - 一般静止：新零偏 = 旧零偏×0.95 + 当前值×0.05
   - 非常静止：新零偏 = 旧零偏×0.80 + 当前值×0.20
```

## 7.2 角度积分算法

使用**梯形积分法**：

```c
// 梯形积分公式
float avg_velocity = (current_dps + last_dps) * 0.5f;
angle += avg_velocity * dt;  // dt = 0.005秒
```

**优点**：比矩形法更精确，减少积分误差

## 7.3 饱和保护算法

```c
// 检测饱和
float raw_lsb = raw_dps * 280.0f;
if (fabsf(raw_lsb) > 27500.0f) {
    // 限制输出在±100°/s
    corrected = clamp(corrected, -100.0f, 100.0f);
}
```

---

# 附录A：常见问题

## A.1 传感器未就绪
- **现象**：LED快速闪烁
- **原因**：SPI通信失败或传感器未唤醒
- **解决**：检查SPI连线，确保供电正常

## A.2 角度漂移
- **现象**：静止时角度缓慢变化
- **原因**：零偏校准不准确
- **解决**：确保启动时设备完全静止2秒以上

## A.3 CAN无法发送
- **现象**：发送函数返回HAL_TIMEOUT
- **原因**：CAN总线无终端电阻或波特率不匹配
- **解决**：检查120Ω终端电阻，确认波特率500kbps

---

# 附录B：修订历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | 2025-11-28 | 初始版本 |

